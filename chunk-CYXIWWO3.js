import{a as h,b as g,c as f,e as B,f as e,g as b,i as d,j as a}from"./chunk-S4DGWORY.js";import{C as o,Da as u,Tb as c,p as m,t as s}from"./chunk-WV57AIYY.js";var v={toFirestore(t){return{remainingBalls:t.remainingBalls,drawnNumbers:t.drawnNumbers,currentBall:t.currentBall,isAnimating:t.isAnimating}},fromFirestore(t){let i=t.data();return{remainingBalls:i.remainingBalls,drawnNumbers:i.drawnNumbers,currentBall:i.currentBall,isAnimating:i.isAnimating}}},D=class t{numbersBingo=90;animationDuration=1e3;intervalStep=50;animationIntervalId=null;roomId=null;roomSub=null;remainingBalls=o([]);drawnNumbers=o([]);currentBall=o(null);isAnimating=o(!1);firestore=s(f);alertService=s(c);constructor(){u(()=>{this.isAnimating()&&this.animationBalls()})}async createRoom(i){this.roomId=i;let n=e(this.firestore,"rooms",i);if(await this.existRoom(n)){console.log(`La sala ${i} ya existe.`),this.listenRoom();return}let r={remainingBalls:Array.from({length:this.numbersBingo},(l,p)=>p+1),drawnNumbers:[],currentBall:null,isAnimating:!1};await d(e(this.firestore,"rooms",i),r),this.listenRoom()}async joinRoom(i){this.roomId=i;let n=e(this.firestore,"rooms",this.roomId);return await this.existRoom(n)?(this.listenRoom(),!0):(this.alertService.show(`La sala con id ${this.roomId} no existe`,"error",4e3),!1)}listenRoom(){if(!this.roomId)return;this.roomSub&&this.roomSub.unsubscribe();let i=e(this.firestore,"rooms",this.roomId).withConverter(v);this.roomSub=B(i).subscribe(n=>{n&&(this.remainingBalls.set(n.remainingBalls),this.drawnNumbers.set(n.drawnNumbers),this.currentBall.set(n.currentBall),this.isAnimating.set(n.isAnimating))})}async nextBall(){if(this.isAnimating())return;let i=this.remainingBalls();if(!this.roomId||i.length===0)return;let n=Math.floor(Math.random()*i.length),r=i[n];await a(e(this.firestore,"rooms",this.roomId),{isAnimating:!0}),setTimeout(async()=>{await a(e(this.firestore,"rooms",this.roomId),{currentBall:r,remainingBalls:g(r),drawnNumbers:h(r),isAnimating:!1})},this.animationDuration)}async resetBalls(){if(!this.roomId)return;let i={remainingBalls:Array.from({length:this.numbersBingo},(r,l)=>l+1),drawnNumbers:[],currentBall:null,isAnimating:!1},n=e(this.firestore,"rooms",this.roomId);await a(n,{remainingBalls:i.remainingBalls,drawnNumbers:i.drawnNumbers,currentBall:i.currentBall,isAnimating:i.isAnimating})}animationBalls(){let i=Date.now();this.animationIntervalId=setInterval(()=>{if(Date.now()-i>=this.animationDuration)clearInterval(this.animationIntervalId);else{let r=Math.floor(Math.random()*this.remainingBalls().length);this.currentBall.set(this.remainingBalls()[r])}},this.intervalStep)}async existRoom(i){return(await b(i)).exists()}static \u0275fac=function(n){return new(n||t)};static \u0275prov=m({token:t,factory:t.\u0275fac,providedIn:"root"})};export{D as a};
